<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eclipseæ¤œç´¢çµæœãƒ„ãƒªãƒ¼æ•´å½¢ãƒ„ãƒ¼ãƒ«</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 10px;
      }
      .description {
        color: #666;
        margin-bottom: 20px;
        font-size: 14px;
      }
      textarea {
        width: 100%;
        min-height: 250px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-family: "Consolas", "Monaco", monospace;
        font-size: 12px;
        resize: vertical;
        box-sizing: border-box;
        line-height: 1.5;
      }
      textarea:focus {
        outline: none;
        border-color: #4caf50;
      }
      .controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #45a049;
      }
      button.secondary {
        background-color: #2196f3;
      }
      button.secondary:hover {
        background-color: #0b7dda;
      }
      label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #555;
      }
      select {
        padding: 6px 10px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      .input-section {
        margin-bottom: 20px;
      }
      .section-title {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .clear-btn {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        font-weight: normal;
        transition: background-color 0.3s;
      }
      .clear-btn:hover {
        background-color: #da190b;
      }
      #output {
        background-color: #f9f9f9;
        white-space: pre;
        overflow-x: auto;
      }
      .example {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 20px 0;
        font-size: 13px;
      }
      .example-title {
        font-weight: bold;
        margin-bottom: 8px;
        color: #856404;
      }
      .stats {
        background-color: #e8f5e9;
        padding: 10px 15px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 13px;
        color: #2e7d32;
      }
      .warning {
        background-color: #fff3cd;
        border-left: 4px solid #ff9800;
        padding: 10px 15px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 13px;
        color: #856404;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸŒ² Eclipseæ¤œç´¢çµæœãƒ„ãƒªãƒ¼æ•´å½¢ãƒ„ãƒ¼ãƒ«</h1>
      <p class="description">
        Eclipseã®æ¤œç´¢çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã‚‹ã¨ã€ãƒ„ãƒªãƒ¼æ§‹é€ ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä»˜ãï¼‰ã«æ•´å½¢ã—ã¾ã™
      </p>

      <div class="example">
        <div class="example-title">ä½¿ã„æ–¹:</div>
        1. Eclipseã§æ¤œç´¢ã‚’å®Ÿè¡Œï¼ˆCtrl+Hï¼‰<br />
        2. æ¤œç´¢çµæœãƒ“ãƒ¥ãƒ¼ã®å·¦ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒShow as Listã€ã‚’é¸æŠ<br />
        3. å…¨é¸æŠï¼ˆCtrl+Aï¼‰ã—ã¦ã‚³ãƒ”ãƒ¼<br />
        4. ä¸‹ã®ã€Œãƒ‘ã‚¹æƒ…å ±ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è²¼ã‚Šä»˜ã‘<br />
        5. ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ãƒãƒƒãƒè¡Œã®è©³ç´°ã‚‚å«ã‚ãŸã„å ´åˆã¯ã€ã€ŒShow as
        Treeã€ã§ã‚³ãƒ”ãƒ¼ã—ã¦ã€Œè©³ç´°æƒ…å ±ã€ã«è²¼ã‚Šä»˜ã‘<br />
        6. ã€Œãƒ„ãƒªãƒ¼æ§‹é€ ã«æ•´å½¢ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
      </div>

      <div class="input-section">
        <div class="section-title">
          ãƒ‘ã‚¹æƒ…å ±ï¼ˆå¿…é ˆï¼‰:
          <button
            class="clear-btn"
            onclick="clearInput('pathInput')"
            title="ã‚¯ãƒªã‚¢"
          >
            âœ•
          </button>
        </div>
        <textarea
          id="pathInput"
          placeholder="ä¾‹:
AdminMemberPointRecordInputBean.java - ebisu3/src/jp/co/interfactory/ebisu/command/admin/member (18 å€‹ã®ä¸€è‡´)
AdminOrderInputBaseBean.java - ebisu3/src/jp/co/interfactory/ebisu/command/admin/order (4 å€‹ã®ä¸€è‡´)"
        ></textarea>
      </div>

      <div class="input-section">
        <div class="section-title">
          è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ãƒãƒƒãƒè¡Œã‚’å«ã‚ã‚‹å ´åˆï¼‰:
          <button
            class="clear-btn"
            onclick="clearInput('detailInput')"
            title="ã‚¯ãƒªã‚¢"
          >
            âœ•
          </button>
        </div>
        <textarea
          id="detailInput"
          placeholder="ä¾‹:
AdminMemberPointRecordInputBean.java (18 å€‹ã®ä¸€è‡´)
131: setData(...
346: return ..."
        ></textarea>
      </div>

      <div class="controls">
        <button onclick="formatTree()">ãƒ„ãƒªãƒ¼æ§‹é€ ã«æ•´å½¢</button>
        <button class="secondary" onclick="copyOutput()">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="secondary" onclick="clearAll()">å…¨ã¦ã‚¯ãƒªã‚¢</button>
        <label>
          ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ:
          <select id="indentType">
            <option value="space2">2ã‚¹ãƒšãƒ¼ã‚¹</option>
            <option value="space4">4ã‚¹ãƒšãƒ¼ã‚¹</option>
            <option value="tab">ã‚¿ãƒ–</option>
          </select>
        </label>
        <label>
          <input type="checkbox" id="showIcons" checked />
          ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
        </label>
      </div>

      <div class="input-section">
        <div class="section-title">å‡ºåŠ›ï¼ˆãƒ„ãƒªãƒ¼æ§‹é€ ï¼‰:</div>
        <div id="stats" class="stats" style="display: none"></div>
        <div id="warning" class="warning"></div>
        <textarea id="output" readonly></textarea>
      </div>
    </div>

    <script>
      function formatTree() {
        const pathInput = document.getElementById("pathInput").value;
        const detailInput = document.getElementById("detailInput").value;
        const indentType = document.getElementById("indentType").value;
        const showIcons = document.getElementById("showIcons").checked;

        let indent = "  ";
        if (indentType === "space4") indent = "    ";
        if (indentType === "tab") indent = "\t";

        // ãƒ‘ã‚¹æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹
        const pathLines = pathInput.split("\n");
        const fileInfoList = [];

        for (const line of pathLines) {
          if (!line.trim()) continue;

          const match = line.match(
            /^(.+?)\s+-\s+(.+?)(?:\s+\((\d+)\s*å€‹ã®ä¸€è‡´\))?$/
          );
          if (match) {
            const [, filename, path, matchCount] = match;
            fileInfoList.push({
              filename: filename.trim(),
              fullPath: path.trim() + "/" + filename.trim(),
              path: path.trim(),
              matchCount: matchCount ? parseInt(matchCount) : 0,
            });
          }
        }

        // è©³ç´°æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹
        const detailList = [];

        if (detailInput.trim()) {
          const detailLines = detailInput.split("\n");
          let currentFilename = null;
          let currentMatches = [];
          let currentRootDir = null;

          for (const line of detailLines) {
            if (!line.trim()) continue;

            const content = line.trim();

            // ãƒãƒƒãƒè¡Œï¼ˆè¡Œç•ªå·ã§å§‹ã¾ã‚‹ - ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«ã‚‚å¯¾å¿œï¼‰
            if (content.match(/^[\d,]+:/)) {
              if (currentFilename) {
                currentMatches.push(content);
              }
              continue;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«åè¡Œï¼ˆæ‹¡å¼µå­ãŒã‚ã‚‹ï¼‰
            if (
              content.match(/\.(java|xml|properties|jsp|js|css|html)(\s+\(|$)/i)
            ) {
              // å‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
              if (currentFilename && currentMatches.length > 0) {
                detailList.push({
                  filename: currentFilename,
                  matches: [...currentMatches],
                  rootDir: currentRootDir,
                });
              }

              // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«
              const fileMatch = content.match(/^(.+?)\s+\((\d+)\s*å€‹ã®ä¸€è‡´\)$/);
              currentFilename = fileMatch
                ? fileMatch[1].trim()
                : content.split(/\s+/)[0];
              currentMatches = [];
              continue;
            }

            // ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãªã—ã€å¤§æ–‡å­—ãƒ»ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ãƒ»æ•°å­—ã®ã¿ï¼‰
            if (
              !line.match(/^\s/) &&
              content.length > 0 &&
              !content.match(/^[\d,]+:/)
            ) {
              if (content.match(/^[A-Z_0-9]+$/)) {
                currentRootDir = content;
              }
            }
          }

          // æœ€å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
          if (currentFilename && currentMatches.length > 0) {
            detailList.push({
              filename: currentFilename,
              matches: [...currentMatches],
              rootDir: currentRootDir,
            });
          }
        }

        // ãƒ‘ã‚¹æƒ…å ±ã¨è©³ç´°æƒ…å ±ã‚’ãƒãƒ¼ã‚¸
        const fileOrder = [];

        for (const fileInfo of fileInfoList) {
          let matches = [];
          let bestMatch = null;
          let bestMatchScore = -1;

          // ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«ä¸€è‡´ã™ã‚‹è©³ç´°æƒ…å ±ã‚’æ¢ã™
          for (const detail of detailList) {
            if (detail.filename !== fileInfo.filename) continue;
            if (detail._used) continue;

            if (detail.rootDir) {
              const score = calculatePathSimilarity(
                fileInfo.path,
                detail.rootDir
              );
              if (score > bestMatchScore) {
                bestMatchScore = score;
                bestMatch = detail;
              }
            } else if (!bestMatch) {
              bestMatch = detail;
              bestMatchScore = 0;
            }
          }

          if (bestMatch) {
            matches = bestMatch.matches;
            bestMatch._used = true;
          }

          fileOrder.push({
            filename: fileInfo.filename,
            fullPath: fileInfo.fullPath,
            path: fileInfo.path,
            matchCount: fileInfo.matchCount,
            matches: matches,
          });
        }

        // ãƒ‘ã‚¹é¡ä¼¼åº¦ã‚’è¨ˆç®—
        function calculatePathSimilarity(fullPath, rootDir) {
          const pathUpper = fullPath.toUpperCase();
          const rootUpper = rootDir.toUpperCase();

          // client_infoé…ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’æŠ½å‡º
          const clientInfoMatch = pathUpper.match(/CLIENT_INFO\/([^\/]+)/);

          if (clientInfoMatch) {
            const projectName = clientInfoMatch[1];

            if (projectName === rootUpper) {
              return 1000;
            } else if (
              projectName.includes(rootUpper) ||
              rootUpper.includes(projectName)
            ) {
              return 100;
            }
          } else {
            // client_infoãŒãªã„å ´åˆã¯ã€ãƒ‘ã‚¹å…¨ä½“ã‹ã‚‰æ¢ã™
            const pathParts = pathUpper.split("/");
            for (const part of pathParts) {
              if (part === rootUpper) {
                return 1000;
              }
            }
          }

          return 0;
        }

        // ãƒ„ãƒªãƒ¼æ§‹é€ ã‚’æ§‹ç¯‰
        const tree = {};

        for (const fileInfo of fileOrder) {
          const parts = fileInfo.path.split("/");
          let current = tree;

          for (let i = 0; i < parts.length; i++) {
            const part = parts[i];
            if (!current[part]) {
              current[part] = { _isFolder: true, _children: {}, _files: [] };
            }
            current = current[part]._children;
          }

          if (!current._files) current._files = [];
          current._files.push({
            filename: fileInfo.filename,
            matchCount: fileInfo.matchCount,
            matches: fileInfo.matches,
          });
        }

        // ãƒ„ãƒªãƒ¼ã‚’å‡ºåŠ›
        const result = [];
        let fileCount = 0;

        function outputTree(node, depth) {
          const folders = [];
          for (const [name, child] of Object.entries(node)) {
            if (name.startsWith("_")) continue;
            if (child._isFolder) {
              folders.push(name);
            }
          }
          folders.sort();

          for (const name of folders) {
            const child = node[name];
            const indentStr = indent.repeat(depth);
            const icon = showIcons ? "ğŸ“ " : "";
            result.push(indentStr + icon + name);
            outputTree(child._children, depth + 1);
          }

          if (node._files && node._files.length > 0) {
            for (const fileInfo of node._files) {
              const indentStr = indent.repeat(depth);
              let icon = "";

              if (showIcons) {
                const name = fileInfo.filename;
                if (name.endsWith(".java")) icon = "ğŸ“„ ";
                else if (name.endsWith(".xml")) icon = "ğŸ“‹ ";
                else if (name.endsWith(".properties")) icon = "âš™ï¸ ";
                else if (name.endsWith(".jsp")) icon = "ğŸŒ ";
                else if (name.endsWith(".js")) icon = "ğŸ“œ ";
                else if (name.endsWith(".css")) icon = "ğŸ¨ ";
                else icon = "ğŸ“„ ";
              }

              fileCount++;
              const matchInfo =
                fileInfo.matchCount > 0
                  ? ` (${fileInfo.matchCount} å€‹ã®ä¸€è‡´)`
                  : "";
              result.push(indentStr + icon + fileInfo.filename + matchInfo);

              if (fileInfo.matches && fileInfo.matches.length > 0) {
                const matchIndent = indent.repeat(depth + 1);
                for (const match of fileInfo.matches) {
                  result.push(matchIndent + match);
                }
              }
            }
          }
        }

        outputTree(tree, 0);

        document.getElementById("output").value = result.join("\n");

        // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
        const statsDiv = document.getElementById("stats");
        statsDiv.style.display = "block";
        statsDiv.textContent = `æ•´å½¢å®Œäº†: ${fileCount} ãƒ•ã‚¡ã‚¤ãƒ«, ${result.length} è¡Œ`;

        // è­¦å‘Šè¡¨ç¤º
        const warningDiv = document.getElementById("warning");
        const unusedDetails = detailList.filter((d) => !d._used);

        if (unusedDetails.length > 0) {
          const unusedFiles = unusedDetails
            .map((d) => d.filename)
            .slice(0, 5)
            .join(", ");
          const more =
            unusedDetails.length > 5 ? ` ä»–${unusedDetails.length - 5}ä»¶` : "";
          warningDiv.style.display = "block";
          warningDiv.textContent = `è­¦å‘Š: ä»¥ä¸‹ã®è©³ç´°æƒ…å ±ãŒãƒ‘ã‚¹æƒ…å ±ã¨ãƒãƒƒãƒã—ã¾ã›ã‚“ã§ã—ãŸ: ${unusedFiles}${more}`;
        } else {
          warningDiv.style.display = "none";
        }
      }

      function copyOutput() {
        const output = document.getElementById("output");
        output.select();
        document.execCommand("copy");

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!";
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }

      function clearInput(inputId) {
        document.getElementById(inputId).value = "";
      }

      function clearAll() {
        document.getElementById("pathInput").value = "";
        document.getElementById("detailInput").value = "";
        document.getElementById("output").value = "";
        document.getElementById("stats").style.display = "none";
        document.getElementById("warning").style.display = "none";
      }
    </script>
  </body>
</html>
