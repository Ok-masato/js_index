<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSVã‚¨ãƒ©ãƒ¼è¡Œå‰Šé™¤ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 14px;
      }

      .content {
        padding: 30px;
      }

      .section {
        margin-bottom: 30px;
      }

      .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 4px;
        height: 20px;
        background: #667eea;
        margin-right: 10px;
        border-radius: 2px;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .file-input-wrapper input[type="file"] {
        display: none;
      }

      .file-input-label {
        display: block;
        padding: 20px;
        background: #f8f9fa;
        border: 2px dashed #667eea;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .file-input-label:hover {
        background: #e9ecef;
        border-color: #764ba2;
      }

      .file-input-label.has-file {
        background: #e7f3ff;
        border-color: #2196f3;
      }

      textarea {
        width: 100%;
        min-height: 200px;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        resize: vertical;
        transition: border-color 0.3s;
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .info-box {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .result-box {
        background: #d4edda;
        border-left: 4px solid #28a745;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        font-size: 14px;
      }

      .error-box {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        font-size: 14px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“Š CSVã‚¨ãƒ©ãƒ¼è¡Œå‰Šé™¤ãƒ„ãƒ¼ãƒ«</h1>
        <p>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰è©²å½“è¡Œã‚’è‡ªå‹•å‰Šé™¤</p>
      </div>

      <div class="content">
        <div class="info-box">
          <strong>ğŸ’¡ ä½¿ã„æ–¹:</strong>
          CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚<br />
          ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æœ‰ç„¡ã«ã‚ˆã£ã¦ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡Œç•ªå·ã®è§£é‡ˆãŒå¤‰ã‚ã‚Šã¾ã™ã€‚
        </div>

        <div class="section">
          <div class="section-title">1. CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
          <div class="file-input-wrapper">
            <input type="file" id="csvFile" accept=".csv" />
            <label for="csvFile" class="file-input-label" id="fileLabel">
              <div style="font-size: 48px; margin-bottom: 10px">ğŸ“</div>
              <div>ã‚¯ãƒªãƒƒã‚¯ã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
              <div style="font-size: 12px; color: #666; margin-top: 5px">
                ã¾ãŸã¯ã€ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
              </div>
            </label>
          </div>
          <div
            style="
              padding: 15px;
              background: #f8f9fa;
              border-radius: 8px;
              margin-top: 15px;
            "
          >
            <div
              style="font-weight: bold; margin-bottom: 10px; font-size: 14px"
            >
              ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®æœ‰ç„¡
            </div>
            <label
              style="
                display: flex;
                align-items: center;
                cursor: pointer;
                margin-bottom: 10px;
              "
            >
              <input
                type="radio"
                name="headerOption"
                value="withHeader"
                checked
                style="
                  margin-right: 10px;
                  width: 18px;
                  height: 18px;
                  cursor: pointer;
                "
              />
              <span style="font-size: 14px"
                ><strong>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚ã‚Š</strong> -
                ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡Œç•ªå·ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤ã„ãŸãƒ‡ãƒ¼ã‚¿è¡Œã®ç•ªå·</span
              >
            </label>
            <label style="display: flex; align-items: center; cursor: pointer">
              <input
                type="radio"
                name="headerOption"
                value="withoutHeader"
                style="
                  margin-right: 10px;
                  width: 18px;
                  height: 18px;
                  cursor: pointer;
                "
              />
              <span style="font-size: 14px"
                ><strong>ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œãªã—</strong> -
                ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡Œç•ªå·ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã‹ã‚‰ã®è¡Œç•ªå·</span
              >
            </label>
          </div>
        </div>

        <div class="section">
          <div class="section-title">2. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è²¼ã‚Šä»˜ã‘</div>
          <textarea
            id="errorMessages"
            placeholder="ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„&#10;ä¾‹:&#10;* å¿…é ˆå…¥åŠ›é …ç›®ã§ã™ã€‚ (ãƒ¡ãƒ«ãƒã‚¬é…ä¿¡ç”¨ãƒ¡ãƒ¼ãƒ«ãƒ›ã‚¹ãƒˆ) (197è¡Œç›®)&#10;* å¿…é ˆå…¥åŠ›é …ç›®ã§ã™ã€‚ (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆ) (853è¡Œç›®)"
          ></textarea>
        </div>

        <div class="section">
          <button class="button" id="processBtn" disabled>
            ã‚¨ãƒ©ãƒ¼è¡Œã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„CSVã‚’ä½œæˆ
          </button>
        </div>

        <div id="result"></div>
      </div>
    </div>

    <script>
      let originalCsvText = "";
      let csvRowRanges = null; // å„è¡Œã®é–‹å§‹ãƒ»çµ‚äº†ä½ç½®
      let detectedEncoding = null;
      let originalFileName = "";
      let totalRows = 0;

      const fileInput = document.getElementById("csvFile");
      const fileLabel = document.getElementById("fileLabel");
      const errorMessages = document.getElementById("errorMessages");
      const processBtn = document.getElementById("processBtn");
      const result = document.getElementById("result");

      fileInput.addEventListener("change", handleFileSelect);

      fileLabel.addEventListener("dragover", (e) => {
        e.preventDefault();
        fileLabel.style.background = "#e9ecef";
      });

      fileLabel.addEventListener("dragleave", () => {
        if (!csvRowRanges) {
          fileLabel.style.background = "#f8f9fa";
        }
      });

      fileLabel.addEventListener("drop", (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect();
        }
      });

      function handleFileSelect() {
        const file = fileInput.files[0];
        if (!file) return;

        originalFileName = file.name;

        const reader = new FileReader();
        reader.onload = function (e) {
          const arrayBuffer = e.target.result;
          const bytes = new Uint8Array(arrayBuffer);

          // æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º
          detectedEncoding = Encoding.detect(bytes);
          console.log("Detected encoding:", detectedEncoding);

          // Unicodeé…åˆ—ã«å¤‰æ›ã—ã¦ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
          const unicodeArray = Encoding.convert(bytes, {
            to: "UNICODE",
            from: detectedEncoding,
          });
          originalCsvText = Encoding.codeToString(unicodeArray);

          // PapaParseã§æ­£ç¢ºãªè¡Œæ•°ã‚’å–å¾—
          Papa.parse(originalCsvText, {
            skipEmptyLines: false,
            complete: function (results) {
              totalRows = results.data.length;

              // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å„è«–ç†è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
              csvRowRanges = extractCsvRows(originalCsvText, results.data);

              fileLabel.classList.add("has-file");
              fileLabel.innerHTML = `
                            <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
                            <div><strong>${file.name}</strong></div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${totalRows}è¡Œ (ãƒ˜ãƒƒãƒ€ãƒ¼å«ã‚€) | ãƒ‡ãƒ¼ã‚¿è¡Œ: ${
                totalRows - 1
              }è¡Œ | æ–‡å­—ã‚³ãƒ¼ãƒ‰: ${detectedEncoding}
                            </div>
                        `;
              checkEnableButton();
            },
          });
        };
        reader.readAsArrayBuffer(file);
      }

      errorMessages.addEventListener("input", checkEnableButton);

      function checkEnableButton() {
        processBtn.disabled = !(csvRowRanges && errorMessages.value.trim());
      }

      // å…ƒã®CSVãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å„è«–ç†è¡Œã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
      function extractCsvRows(text, parsedData) {
        const rows = [];
        let pos = 0;

        for (let i = 0; i < parsedData.length; i++) {
          const rowData = parsedData[i];

          // ã“ã®è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’PapaParseã§å†ç”Ÿæˆ
          const reconstructed = Papa.unparse([rowData], {
            quotes: false,
            quoteChar: '"',
            escapeChar: '"',
            delimiter: ",",
            newline: "",
          });

          // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã“ã®è¡Œã‚’æ¢ã™
          let searchStart = pos;
          let foundEnd = -1;

          // æ¬¡ã®æ”¹è¡Œã‚’æ¢ã™
          let idx = searchStart;
          let inQuotes = false;

          while (idx < text.length) {
            const char = text[idx];

            if (char === '"') {
              // æ¬¡ã®æ–‡å­—ã‚‚ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆãªã‚‰ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¦ã„ã‚‹
              if (idx + 1 < text.length && text[idx + 1] === '"') {
                idx += 2;
                continue;
              }
              inQuotes = !inQuotes;
            } else if (!inQuotes && (char === "\n" || char === "\r")) {
              // ã‚¯ã‚©ãƒ¼ãƒˆå¤–ã®æ”¹è¡Œã‚’ç™ºè¦‹
              foundEnd = idx;
              if (
                char === "\r" &&
                idx + 1 < text.length &&
                text[idx + 1] === "\n"
              ) {
                foundEnd = idx + 2; // \r\n
              } else {
                foundEnd = idx + 1; // \n or \r
              }
              break;
            }

            idx++;
          }

          // æœ€çµ‚è¡Œã®å ´åˆ
          if (foundEnd === -1) {
            foundEnd = text.length;
          }

          rows.push({
            start: pos,
            end: foundEnd,
          });

          pos = foundEnd;
        }

        return rows;
      }

      processBtn.addEventListener("click", processCSV);

      function processCSV() {
        const errorText = errorMessages.value;
        const rowNumbers = extractRowNumbers(errorText);

        if (rowNumbers.length === 0) {
          result.innerHTML = `
                    <div class="error-box">
                        <strong>âš ï¸ ã‚¨ãƒ©ãƒ¼:</strong> ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰è¡Œç•ªå·ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
                    </div>
                `;
          return;
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        const headerOption = document.querySelector(
          'input[name="headerOption"]:checked'
        ).value;
        const hasHeader = headerOption === "withHeader";

        // å‰Šé™¤å¯¾è±¡ã®è¡Œç•ªå·ã‚’Setã«å…¥ã‚Œã‚‹
        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ã‚Šã®å ´åˆ: ã‚¨ãƒ©ãƒ¼ã®197è¡Œç›® = é…åˆ—ã®197ç•ªç›®ï¼ˆ0:ãƒ˜ãƒƒãƒ€ãƒ¼ã€197:ãƒ‡ãƒ¼ã‚¿197è¡Œç›®ï¼‰
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã®å ´åˆ: ã‚¨ãƒ©ãƒ¼ã®1è¡Œç›® = é…åˆ—ã®1ç•ªç›®ï¼ˆ0:1è¡Œç›®ã€1:2è¡Œç›®ï¼‰
        const rowsToDelete = new Set();
        rowNumbers.forEach((rowNum) => {
          if (hasHeader) {
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚ã‚Šã®å ´åˆã€è¡Œç•ªå·ã‚’ãã®ã¾ã¾ä½¿ç”¨
            rowsToDelete.add(rowNum);
          } else {
            // ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã®å ´åˆã€è¡Œç•ªå·-1ã‚’ä½¿ç”¨ï¼ˆ1è¡Œç›® = ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ï¼‰
            rowsToDelete.add(rowNum - 1);
          }
        });

        // å…ƒã®ãƒ‡ãƒ¼ã‚¿è¡Œæ•°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤ãï¼‰
        const originalDataRows = hasHeader ? totalRows - 1 : totalRows;

        // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è©²å½“è¡Œä»¥å¤–ã‚’æŠ½å‡º
        const segments = [];

        for (let i = 0; i < csvRowRanges.length; i++) {
          if (!rowsToDelete.has(i)) {
            // ã“ã®è¡Œã¯æ®‹ã™
            const range = csvRowRanges[i];
            segments.push(originalCsvText.substring(range.start, range.end));
          }
        }

        const newCsvText = segments.join("");

        // å…ƒã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        const unicodeArray = Encoding.stringToCode(newCsvText);
        const encodedArray = Encoding.convert(unicodeArray, {
          to: detectedEncoding,
          from: "UNICODE",
        });
        const uint8Array = new Uint8Array(encodedArray);

        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob([uint8Array], { type: "text/csv" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);

        // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
        const baseName = originalFileName.replace(/\.csv$/i, "");
        link.setAttribute("download", `${baseName}_cleaned.csv`);

        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿è¡Œæ•°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤ãï¼‰
        const newDataRows = originalDataRows - rowNumbers.length;

        const headerText = hasHeader ? "ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚ã‚Š" : "ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œãªã—";

        // çµæœè¡¨ç¤º
        result.innerHTML = `
                <div class="result-box">
                    <strong>âœ… å‡¦ç†å®Œäº†!</strong> æ–°ã—ã„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${originalDataRows}</div>
                            <div class="stat-label">å…ƒã®ãƒ‡ãƒ¼ã‚¿è¡Œæ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${rowNumbers.length}</div>
                            <div class="stat-label">å‰Šé™¤ã•ã‚ŒãŸè¡Œæ•°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${newDataRows}</div>
                            <div class="stat-label">æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿è¡Œæ•°</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        è¨­å®š: ${headerText}<br>
                        æ–‡å­—ã‚³ãƒ¼ãƒ‰: ${detectedEncoding}<br>
                        å‰Šé™¤ã•ã‚ŒãŸè¡Œç•ªå·: ${Array.from(rowNumbers)
                          .sort((a, b) => a - b)
                          .join(", ")}
                    </div>
                </div>
            `;
      }

      function extractRowNumbers(text) {
        const regex = /\((\d+)è¡Œç›®\)/g;
        const numbers = [];
        let match;

        while ((match = regex.exec(text)) !== null) {
          numbers.push(parseInt(match[1]));
        }

        return numbers;
      }
    </script>
  </body>
</html>
